<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Python Notebook</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>


<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #1e1e1e;
    color: #e0e0e0;
}
#container {
    display: flex;
    height: 100vh;
    width: 100%;
}

#sidebar {
    width: 250px;
    padding: 20px;
    background-color: #282c34; /* Darker background */
    color: #abb2bf; /* Lighter text color */
    height: 100%;
    border-right: 1px solid #454545; /* Subtle border */
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); /* Add a subtle shadow */
}

#sidebar h3 {
    margin-top: 0; /* Remove extra top margin */
    margin-bottom: 10px; /* Add some bottom margin */
    color: #c792ea; /* A nice purple color */
}

#sidebar ul {
    padding-left: 0;
    list-style: none;
}

#sidebar li {
    padding: 8px 10px;
    margin-bottom: 5px;
    background-color: #333;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}

#sidebar li:hover {
    background-color: #444;
}

#sidebar li.active {
    background-color: #c792ea; /* Match h3 color */
    color: #282c34; /* Dark text on active item */
}

#sidebar button {
    margin-top: 10px; /* Add some spacing */
}

/* Style for file actions */
.file-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px; /*Added margin for better spacing */
    background-color: #333;
    padding: 5px;
    border-radius: 4px;
}

.file-actions button {
    margin-left: 5px;
    padding: 5px 10px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
}




#main {
    flex-grow: 1;
    padding: 20px;
    height: 100%;
}
.cell {
    margin-bottom: 20px;
    cursor: move; /* Indicate draggability */
    position: relative; /*Needed for proper drag and drop*/
    border: 1px solid #454545;
    border-radius: 5px;
    overflow: hidden;
    background-color: #2d2d2d;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    position: relative;
    /* Increased default size */
    min-height: 200px;  /* Adjust this value as needed */
    }

    .cell-editor {
    height: auto;
    /* Increased default size */
    min-height: 150px; /* Adjust this value as needed */
    width: 100%;
    border-bottom: 1px solid #454545;
    resize: vertical;
    box-sizing: border-box;
    overflow-y: auto;
    }

    #sidebar-toggle {
    position: absolute;
    top: 10px;
    right: 10px;
}



    .btn-arrow {
    padding: 5px 8px; /* Adjust padding as needed */
}


.cell-output {
    background-color: #1e1e1e;
    padding: 10px;
    min-height: 150px; /* Adjust this value as needed */

    white-space: pre-wrap;
    font-family: 'Courier New', Courier, monospace;
    overflow-y: auto;
    color: #e0e0e0;
    box-sizing: border-box;
}
.cell-output.error {
    background-color: #fdd;
    color: #a00;
    border: 1px solid #faa;
}
.btn {
    background-color: #ff7f00;
    border: none;
    color: #1e1e1e;
    padding: 8px 16px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.3s;
}
.btn:hover {
    background-color: #ff9933;
}
.btn-group {
    display: flex;
    justify-content: flex-start;
    padding: 10px;
    background-color: #333333;
}
.btn-group .btn {
    margin-right: 10px;
}
#file-list {
    list-style-type: none;
    padding: 0;
}
#file-list li {
    cursor: pointer;
    padding: 5px 10px;
    margin: 5px 0;
    background-color: #333333;
    border-radius: 3px;
    transition: background-color 0.3s;
}
#file-list li:hover {
    background-color: #454545;
}
#file-list li.active {
    background-color: #ff7f00;
    color: #1e1e1e;
}
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    margin-bottom: 5px;
}
.form-group input, .form-group select {
    width: 100%;
    padding: 5px;
    border-radius: 3px;
    border: 1px solid #454545;
    background-color: #333333;
    color: #e0e0e0;
}
#hardwareMonitor {
    margin-top: 20px;
    background-color: #333333;
    padding: 10px;
    border-radius: 5px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    grid-gap: 5px;
}
#hardwareMonitor > div {
    background-color: #2d2d2d;
    padding: 5px;
    border-radius: 5px;
    text-align: center;
}
.hardware-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}
.hardware-item h3 {
    margin-bottom: 3px;
    font-size: 14px;
}
.progress-bar {
    width: 100%;
    height: 15px;
    background-color: #454545;
    border-radius: 5px;
    margin-bottom: 3px;
    overflow: hidden;
}
.progress-bar-fill {
    height: 100%;
    background-color: #ff7f00;
    transition: width 0.5s ease-in-out;
}
.progress-bar-label {
    font-size: 12px;
}
@media (max-width: 500px) {
    #hardwareMonitor {
        grid-template-columns: 1fr;
    }
}
#variable-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #2d2d2d;
    color: #e0e0e0;
    padding: 20px;
    border: 1px solid #454545;
    border-radius: 5px;
    z-index: 1000;
    max-width: 500px;
    overflow-y: auto;
}
#variable-popup ul {
    list-style: none;
    padding: 0;
}
#variable-popup li {
    margin-bottom: 5px;
}
.custom-cell-input {
    margin-bottom: 10px;
}
.custom-cell-input input,
.custom-cell-input select {
    width: 100%;
    padding: 5px;
    border-radius: 3px;
    border: 1px solid #454545;
    background-color: #333333;
    color: #e0e0e0;
}
.resizer {
    position: absolute;
    width: 5px;
    height: 100%;
    background-color: #555;
    cursor: ew-resize;
    z-index: 1;
    top: 0;
    right: 0;
}
.gpu-monitor {
    display: flex;
    flex-wrap: wrap;
}
.gpu-monitor > div {
    width: 20%;
    margin-right: 10px;
    margin-bottom: 10px;
}

#notebook {
    display: flex;
    flex-direction: column; /* Important for stacking cells vertically */
}

#file-upload {
    margin-bottom: 10px;
}
#file-upload input[type="file"] {
    padding: 5px;
    border-radius: 3px;
    border: 1px solid #454545;
    background-color: #333333;
    color: #e0e0e0;
}
#file-upload button {
    margin-left: 10px;
}
.custom-cell {
    display: flex;
    gap: 10px;
    padding-bottom: 70px;
    min-height: 200px;
}
.custom-cell-params {
    width: 250px;
    flex-shrink: 0;
    border-right: 2px solid #555;
    padding: 10px;
    padding-bottom: 20px;
}
.custom-cell-params .form-group {
    margin-bottom: 10px;
}
.custom-cell-params label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}
.custom-cell-code {
    flex-grow: 1;
}
.cell.custom-cell {
    border: 2px solid #555;
    box-shadow: 2px 4px 10px rgba(0,0,0,0.3);
}
.cell.custom-cell .cell-editor {
    background: #333;
    padding: 10px;
    padding-bottom: 20px;
}
pre {
    background-color: #222;
    padding: 10px;
    overflow-x: auto;
    padding-bottom: 20px;
    font-family: 'Courier New', Courier, monospace;
}
.executed-code {
    background-color: #333;
    padding: 10px;
    border: 1px solid #555;
    margin-top: 10px;
    font-family: 'Courier New', Courier, monospace;
    color: #e0e0e0;
    overflow-x: auto;
    white-space: pre-wrap; /*Important for wrapping long lines*/
}

#custom-cell-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #2d2d2d;
    color: #e0e0e0;
    padding: 20px;
    border: 1px solid #454545;
    border-radius: 5px;
    z-index: 1000;
    max-width: 300px;
}
#custom-cell-popup ul {
    list-style: none;
    padding: 0;
}
#custom-cell-popup li {
    margin-bottom: 5px;
    cursor: pointer;
}
#custom-cell-popup li.selected {
    background-color: #ff7f00;
    color: #1e1e1e;
}











        















    </style>
</head>
<body>    <div id="container">
    <div id="sidebar">
        <h3><i class="fas fa-file-code"></i> Files</h3>
        <ul id="file-list"></ul>
        <div class="form-group">
            <input type="text" id="new-file-name" placeholder="New file name">
            <button class="btn" onclick="createFile()"><i class="fas fa-plus"></i> Create File</button>
        </div>
        <div class="form-group">
            <label for="timeout">Execution Timeout (seconds):</label>
            <input type="number" id="timeout" value="10" min="1">
        </div>
        <div class="form-group">
            <label for="theme">Theme:</label>
            <select id="theme" onchange="changeTheme()">
                <option value="monokai">Monokai</option>
                <option value="github">GitHub</option>
                <option value="twilight">Twilight</option>
                <option value="solarized_dark">Solarized Dark</option>
                <option value="xcode">Xcode</option>
                <option value="kuroir">Kuroir</option>
                <option value="dracula">Dracula</option>
            </select>
        </div>
        <h3><i class="fas fa-microchip"></i> Hardware Monitor</h3>
        <div id="hardwareMonitor">
            <div class="hardware-item">
                <h3>CPU</h3>
                <div class="progress-bar">
                    <div id="cpu-bar" class="progress-bar-fill"></div>
                </div>
                <div id="cpu-percent" class="progress-bar-label"></div>
            </div>
            <div class="hardware-item">
                <h3>RAM</h3>
                <div class="progress-bar">
                    <div id="ram-bar" class="progress-bar-fill"></div>
                </div>
                <div id="ram-percent" class="progress-bar-label"></div>
            </div>
            <div class="hardware-item">
                <h3>Disk Space</h3>
                <div class="progress-bar">
                    <div id="disk-bar" class="progress-bar-fill"></div>
                </div>
                <div id="disk-percent" class="progress-bar-label"></div>
            </div>
            <div class="hardware-item">
                <h3>GPU</h3>
                <div id="gpu-monitor"></div>
            </div>
        </div>
        <button class="btn" onclick="pipInstall()">Pip Install</button>
        <div id="file-upload">
            <input type="file" id="upload-input">
            <button class="btn" onclick="uploadFile()">Upload File</button>
        </div>
    </div>
    <div id="resizer"></div>
    <div id="main">
        <div id="notebook">
            <!-- Cells will be dynamically added here -->
        </div>
        <div class="btn-group">
            <button class="btn" onclick="addCell()"><i class="fas fa-plus"></i> Add Cell</button>
            <button class="btn" onclick="showCustomCellPopup()"><i class="fas fa-plus-circle"></i> Add Custom Cell</button>
            <button class="btn" onclick="saveNotebook()">Save Notebook</button>
            <button class="btn" onclick="saveFile()">Save File</button>  <!-- Added Save File button -->
            <button class="btn" onclick="showVariables()">Show Variables</button>
            <button class="btn" onclick="resetKernel()">Reset Kernel</button>
        </div>
    </div>
</div>

<div id="custom-cell-popup">
    <h3>Select Custom Cell Type</h3>
    <ul id="custom-cell-types">
        <li data-type="example1" onclick="addCustomCell('example1')">Ex 1 (TF net)</li>
        <li data-type="example2" onclick="addCustomCell('example2')">EX 2 (Matplot lib)</li>  
        <li data-type="example3" onclick="addCustomCell('example3')">EX 3 (Load CSV)</li>  
    </ul>
    <button class="btn" onclick="hidecustoms()">Close</button>
</div>

<div id="variable-popup">
    <h3>Runtime Variables</h3>
    <ul id="variable-list"></ul>
    <button class="btn" onclick="hideVariables()">Close</button>
</div>

    









    


    <script>

const socket = io();
let cellCount = 0;
let currentFile = null;
let sidebarCollapsed = false; // Track sidebar collapse state

// Function to prevent sidebar scrolling
function preventSidebarScroll() {
    const sidebar = document.getElementById('sidebar');
    sidebar.style.overflowY = 'hidden'; // Prevent vertical scroll
}

// Function to allow sidebar scrolling (if needed)
function allowSidebarScroll() {
    const sidebar = document.getElementById('sidebar');
    sidebar.style.overflowY = 'auto'; // Allow vertical scroll
}


//Improved drag and drop functionality (using up/down arrows)
function adjustCellHeight(editor) {
    const cell = editor.container.parentElement;
    const editorDiv = cell.querySelector('.cell-editor');
    const outputDiv = cell.querySelector('.cell-output');

    editorDiv.style.height = 'auto';
    outputDiv.style.height = 'auto';

    editorDiv.style.minHeight = '150px';
    outputDiv.style.minHeight = '50px';

    const editorHeight = editorDiv.scrollHeight;
    const outputHeight = outputDiv.scrollHeight;

    cell.style.height = `${Math.max(200, editorHeight + outputHeight + 50)}px`;
    editor.resize();
}

function moveCell(cellId, direction) {
    const cell = document.getElementById(cellId);
    if (!cell) return;
    const notebook = document.getElementById('notebook');
    const cells = Array.from(notebook.children);
    const index = cells.indexOf(cell);

    if (direction === 'up' && index > 0) {
        notebook.insertBefore(cell, cells[index - 1]);
    } else if (direction === 'down' && index < cells.length - 1) {
        notebook.insertBefore(cell, cells[index + 2]); 
    }
    saveCellOrder(getCellIds());
}

function getCellIds() {
    return Array.from(document.querySelectorAll('.cell'))
        .map(cell => cell.id);
}

function saveCellOrder(cellIds) {
    if (currentFile) {
        fetch('/save_cell_order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: currentFile, cellIds: cellIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error("Error saving cell order:", data.error);
                alert("Error saving cell order!");
            } else {
                console.log("Cell order saved successfully:", data.message);
            }
        })
        .catch(error => {
            console.error("Error saving cell order:", error);
            alert("Error saving cell order!");
        });
    } else {
        console.warn("No file loaded. Cell order not saved.");
    }
}

function loadFile(fileName) {
    currentFile = fileName;
    fetch('/get_file_content', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: fileName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.content) {
            document.getElementById('notebook').innerHTML = ''; 
            const content = data.content;
            const contentLines = content.split('\n\n');

            fetch('/load_cell_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: fileName })
            })
            .then(response => response.json())
            .then(orderData => {
                const cellOrder = orderData.cell_ids || []; 

                if (cellOrder.length > 0) {
                    cellOrder.forEach(cellId => {
                        addExistingCell(cellId, contentLines[cellOrder.indexOf(cellId)]);
                    });
                } else {
                    contentLines.forEach(line => {
                        addCell();
                        const editor = ace.edit(`editor-cell-${cellCount}`);
                        editor.setValue(line);
                        adjustCellHeight(editor);
                    });
                }
            })
            .catch(error => {
                console.error("Error loading cell order:", error);
                alert("Error loading cell order!");
            });

            const fileListItem = Array.from(document.querySelectorAll('#file-list li'))
                .find(li => li.textContent.trim() === fileName);
            if (fileListItem) {
                document.querySelectorAll('#file-list li').forEach(li => li.classList.remove('active'));
                fileListItem.classList.add('active');
            }
        } else {
            alert(data.error || "Error loading file.");
        }
    })
    .catch(error => {
        console.error("Error loading file:", error);
        alert("Error loading file: " + error.message);
    });
}

function addExistingCell(cellId, content) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.id = cellId;

    const editorDiv = document.createElement('div');
    editorDiv.className = 'cell-editor';
    editorDiv.id = `editor-${cellId}`;
    cell.appendChild(editorDiv);

    const btnGroup = createButtonGroup(cellId);
    cell.appendChild(btnGroup);

    const outputDiv = document.createElement('div');
    outputDiv.className = 'cell-output';
    outputDiv.id = `output-${cellId}`;
    cell.appendChild(outputDiv);

    document.getElementById('notebook').appendChild(cell);

    const editor = ace.edit(`editor-${cellId}`);
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");
    editor.setValue(content);
    adjustCellHeight(editor);
}


function addCell() {
    cellCount++;
    const cellId = `cell-${cellCount}`;

    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.id = cellId;

    const editorDiv = document.createElement('div');
    editorDiv.className = 'cell-editor';
    editorDiv.id = `editor-${cellId}`;
    cell.appendChild(editorDiv);

    const btnGroup = createButtonGroup(cellId);
    cell.appendChild(btnGroup);

    const outputDiv = document.createElement('div');
    outputDiv.className = 'cell-output';
    outputDiv.id = `output-${cellId}`;
    cell.appendChild(outputDiv);

    document.getElementById('notebook').appendChild(cell);

    const editor = ace.edit(`editor-${cellId}`);
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");

    editor.on("change", () => {
        adjustCellHeight(editor);
    });

    adjustCellHeight(editor);
}

function createButtonGroup(cellId) {
    const btnGroup = document.createElement('div');
    btnGroup.className = 'btn-group';

    const runBtn = document.createElement('button');
    runBtn.className = 'btn';
    runBtn.textContent = 'Run';
    runBtn.onclick = () => runCell(cellId);
    btnGroup.appendChild(runBtn);

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn';
    deleteBtn.textContent = 'Delete';
    deleteBtn.onclick = () => deleteCell(cellId);
    btnGroup.appendChild(deleteBtn);

    const clearBtn = document.createElement('button');
    clearBtn.className = 'btn';
    clearBtn.textContent = 'Clear Output';
    clearBtn.onclick = () => clearOutput(cellId);
    btnGroup.appendChild(clearBtn);

    const upBtn = document.createElement('button');
    upBtn.className = 'btn btn-arrow';
    upBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
    upBtn.onclick = () => moveCell(cellId, 'up');
    btnGroup.appendChild(upBtn);

    const downBtn = document.createElement('button');
    downBtn.className = 'btn btn-arrow';
    downBtn.innerHTML = '<i class="fas fa-arrow-down"></i>';
    downBtn.onclick = () => moveCell(cellId, 'down');
    btnGroup.appendChild(downBtn);

    return btnGroup;
}

function runCell(cellId) {
    const editor = ace.edit(`editor-${cellId}`);
    const cellContent = editor.getValue();
    const timeout = document.getElementById('timeout').value;
    socket.emit('run_cell', { cell_id: cellId, cell_content: cellContent, timeout: timeout });
}

function showCustomCellPopup() {
    document.getElementById('custom-cell-popup').style.display = 'block';
    loadCSVFilesIntoSelect('csv_filename-cell-0'); 
}

function addCustomCell(type) {
    cellCount++;
    const cellId = `cell-${cellCount}`;
    let cellHtml;

    if (type === 'example1') {
        cellHtml = createCustomCellHTML(cellId, type, `
            <div class="form-group">
                <label for="layers-${cellId}">Layers:</label>
                <input type="number" id="layers-${cellId}" value="2" min="1" required>
            </div>
            <div class="form-group">
                <label for="neurons-${cellId}">Neurons per Layer:</label>
                <input type="number" id="neurons-${cellId}" value="32" min="1" required>
            </div>
            <div class="form-group">
                <label for="activation-${cellId}">Activation:</label>
                <select id="activation-${cellId}">
                    <option value="relu">ReLU</option>
                    <option value="sigmoid">Sigmoid</option>
                    <option value="tanh">Tanh</option>
                </select>
            </div>
            <div class="form-group">
                <label for="loss-${cellId}">Loss:</label>
                <select id="loss-${cellId}">
                    <option value="binary_crossentropy">Binary Crossentropy</option>
                    <option value="categorical_crossentropy">Categorical Crossentropy</option>
                    <option value="mse">Mean Squared Error</option>
                </select>
            </div>
            <div class="form-group">
                <label for="optimizer-${cellId}">Optimizer:</label>
                <select id="optimizer-${cellId}">
                    <option value="adam">Adam</option>
                    <option value="sgd">SGD</option>
                    <option value="rmsprop">RMSprop</option>
                </select>
            </div>
            <div class="form-group">
                <label for="epochs-${cellId}">Epochs:</label>
                <input type="number" id="epochs-${cellId}" value="10" min="1" required>
            </div>
        `);
    } else if (type === 'example2') {
        cellHtml = createCustomCellHTML(cellId, type, `
            <div class="form-group">
                <label for="x_data-${cellId}">X Data (list):</label>
                <input type="text" id="x_data-${cellId}" value="[1, 2, 3, 4, 5]" required>
            </div>
            <div class="form-group">
                <label for="y_data-${cellId}">Y Data (list):</label>
                <input type="text" id="y_data-${cellId}" value="[2, 4, 1, 3, 5]" required>
            </div>
        `);
    } else if (type === 'example3') {
        cellHtml = createCustomCellHTML(cellId, type, `
            <div class="form-group">
                <label for="csv_filename-${cellId}">CSV Filename:</label>
                <select id="csv_filename-${cellId}"></select>
            </div>
        `);
    } else {
        console.error("Unknown custom cell type:", type);
        return;
    }

    document.getElementById('notebook').insertAdjacentHTML('beforeend', cellHtml);

    const editor = ace.edit(`editor-${cellId}`);
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");

    if (type === 'example3') {
        loadCSVFilesIntoSelect(`csv_filename-${cellId}`);
    }
    adjustCellHeight(editor);
    hideCustomCellPopup();
}

function createCustomCellHTML(cellId, type, paramsHTML) {
    return `
        <div class="cell custom-cell" id="${cellId}">
            <div class="custom-cell-params">
                ${paramsHTML}
                <button class="btn" onclick="runCustomCell('${cellId}', '${type}')">Run</button>
                <button class="btn" onclick="deleteCell('${cellId}')">Delete</button>
            </div>
            <div class="custom-cell-code">
                <div class="cell-editor" id="editor-${cellId}"></div>
                <div class="cell-output" id="output-${cellId}"></div>
            </div>
        </div>
    `;
}

function deleteCell(cellId) {
    const cell = document.getElementById(cellId);
    if (cell) {
        cell.remove();
        const cellIds = getCellIds();
        saveCellOrder(cellIds);
    }
}

function clearOutput(cellId) {
    const outputDiv = document.getElementById(`output-${cellId}`);
    if (outputDiv) {
        outputDiv.innerHTML = '';
        adjustCellHeight(ace.edit(`editor-${cellId}`)); 
    }
}

socket.on('cell_output', (data) => {
    const outputDiv = document.getElementById(`output-${data.cell_id}`);
    const editor = ace.edit(`editor-${data.cell_id}`);

    if (!outputDiv) {
        console.error(`Output div not found for cell ID: ${data.cell_id}`);
        return;
    }
    outputDiv.innerHTML = ''; 

    if (data.error) {
        const errorOutput = document.createElement('pre');
        errorOutput.className = 'cell-output error';
        errorOutput.textContent = data.error;
        outputDiv.appendChild(errorOutput);
    } else {
        const outputContent = document.createElement('pre');
        outputContent.className = 'executed-code';
        outputContent.textContent = data.output || '';
        outputDiv.appendChild(outputContent);

        if (data.imageData) {
            const img = document.createElement('img');
            img.src = data.imageData[0];
            img.style.maxWidth = '100%';
            img.onload = () => {
                outputDiv.style.height = 'auto';
            };
            outputDiv.appendChild(img);
        }
        if (data.codeToExecute) {
            const editor = ace.edit(`editor-${data.cell_id}`);
            editor.setValue(data.codeToExecute);
            editor.clearSelection();
            editor.session.setMode("ace/mode/python");
            editor.resize();
        }
        adjustCellHeight(editor);
    }
});

function changeTheme() {
    const theme = document.getElementById('theme').value;
    const editors = document.querySelectorAll('.cell-editor');
    editors.forEach(editorElement => {
        const editor = ace.edit(editorElement);
        editor.setTheme(`ace/theme/${theme}`);
    });
}

function createFile() {
    const fileName = document.getElementById('new-file-name').value;
    if (fileName) {
        fetch('/create_file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: fileName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(data.message);
                loadFiles();
            } else {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error("Error creating file:", error);
            alert("Error creating file: " + error.message);
        });
    }
}


function saveFile() {
    if (!currentFile) {
        alert('Please select a file to save');
        return;
    }
    const content = Array.from(document.querySelectorAll('.cell-editor')).map(editorElement => {
        const editor = ace.edit(editorElement);
        return editor.getValue();
    }).join('\n\n');
    fetch('/save_file', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: currentFile, content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error("Error saving file:", error);
        alert("Error saving file: " + error.message);
    });
}

function deleteFile(filename) { 
    if (!filename) { 
        alert('Please select a file to delete');
        return;
    }
    if (confirm(`Are you sure you want to delete ${filename}?`)) {
        fetch('/delete_file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: filename })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(data.message);
                currentFile = null;
                document.getElementById('notebook').innerHTML = '';
                loadFiles();
            } else {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error("Error deleting file:", error);
            alert("Error deleting file: " + error.message);
        });
    }
}

function updateHardwareMonitor(data) {
    document.getElementById('cpu-bar').style.width = `${data.cpu}%`;
    document.getElementById('cpu-percent').textContent = `${data.cpu}%`;
    document.getElementById('ram-bar').style.width = `${data.ram}%`;
    document.getElementById('ram-percent').textContent = `${data.ram}%`;
    document.getElementById('disk-bar').style.width = `${data.disk}%`;
    document.getElementById('disk-percent').textContent = `${data.disk}%`;

    const gpuMonitor = document.getElementById('gpu-monitor');
    gpuMonitor.innerHTML = '';
    if (data.gpus && data.gpus.length > 0) {
        data.gpus.forEach(gpuData => {
            const gpuDiv = document.createElement('div');
            gpuDiv.className = 'hardware-item';
            gpuDiv.innerHTML = `
                <h3>GPU ID:${gpuData.id}</h3>
                <div class="progress-bar">
                    <div class="progress-bar-fill" style="width: ${gpuData.load}%"></div>
                </div>
                <div class="progress-bar-label">${gpuData.load}%</div>
                <div class="progress-bar-label">Memory: ${gpuData.memoryUtil}%</div>
            `;
            gpuMonitor.appendChild(gpuDiv);
        });
    } else {
        gpuMonitor.innerHTML = '<div class="hardware-item">No GPUs detected</div>';
    }
}

setInterval(() => {
    fetch('/hardware_usage')
        .then(response => response.json())
        .then(updateHardwareMonitor);
}, 5000);

function updateVariables(variablesJson) {
    const variableList = document.getElementById('variable-list');
    variableList.innerHTML = '';
    try {
        const variables = JSON.parse(variablesJson);
        for (const [key, value] of Object.entries(variables)) {
            const li = document.createElement('li');
            li.textContent = `${key}: ${JSON.stringify(value)}`;
            variableList.appendChild(li);
        }
    } catch (error) {
        console.error("Error parsing variables:", error);
        variableList.innerHTML = "<li>Error displaying variables</li>";
    }
}

function showVariables() {
    socket.emit('get_variables');
    document.getElementById('variable-popup').style.display = 'block';
}

function hideVariables() {
    document.getElementById('variable-popup').style.display = 'none';
}

function hideCustomCellPopup() {
    document.getElementById('custom-cell-popup').style.display = 'none';
}

function pipInstall() {
    const packageName = prompt("Enter package name:");
    if (packageName) {
        socket.emit('pip_install', { packageName: packageName });
    }
}

socket.on('pip_install_result', (data) => {
    alert(data.message);
});

function saveNotebook() {
    const notebookContent = Array.from(document.querySelectorAll('.cell-editor')).map(editorElement => {
        const editor = ace.edit(editorElement);
        return editor.getValue();
    }).join('\n\n');
    const filename = prompt("Enter filename (optional, defaults to notebook.py):") || 'notebook.py'; 
    socket.emit('save_notebook', { notebookContent: notebookContent, filename: filename });
}

socket.on('save_result', (data) => {
    alert(data.message);
});

socket.on('kernel_reset', (data) => {
    updateVariables(data.variables);
});
socket.on('variables_update', (data) => {
    updateVariables(data.variables);
});

function resetKernel() {
    socket.emit('reset_kernel');
}

function uploadFile() {
    const fileInput = document.getElementById('upload-input');
    const file = fileInput.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('file', file);
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(data.message);
                loadFiles();
            } else {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error("Error uploading file:", error);
            alert("Error uploading file: " + error.message);
        });
    }
}

function downloadFile(filename) {
    window.location.href = `/download/${filename}`;
}

function deleteUploadedFile(filename) {
    if (confirm(`Are you sure you want to delete ${filename}?`)) {
        fetch(`/delete_upload/${filename}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(data.message);
                loadFiles();
            } else {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error("Error deleting uploaded file:", error);
            alert("Error deleting uploaded file: " + error.message);
        });
    }
}


function runCustomCell(cellId, type) {
    const code = ace.edit(`editor-${cellId}`).getValue();
    let params = {};
    if (type === 'example1') {
        params = {
            layers: parseInt(document.getElementById(`layers-${cellId}`).value, 10),
            neurons: parseInt(document.getElementById(`neurons-${cellId}`).value, 10),
            activation: document.getElementById(`activation-${cellId}`).value,
            loss: document.getElementById(`loss-${cellId}`).value,
            optimizer: document.getElementById(`optimizer-${cellId}`).value,
            epochs: parseInt(document.getElementById(`epochs-${cellId}`).value, 10)
        };
    } else if (type === 'example2') {
        params = {
            x_data: document.getElementById(`x_data-${cellId}`).value,
            y_data: document.getElementById(`y_data-${cellId}`).value,
        };
    } else if (type === 'example3') {
        params = {
            filename: document.getElementById(`csv_filename-${cellId}`).value
        };
    }

    socket.emit('run_custom_cell', { cell_id: cellId, code: code, params: params, type: type });
}

function loadCSVFilesIntoSelect(selectId) {
    fetch('/get_files')
        .then(response => response.json())
        .then(data => {
            const selectElement = document.getElementById(selectId);
            if (selectElement) { 
                selectElement.innerHTML = ''; 
                data.files.forEach(file => {
                    if (file.endsWith('.csv')) {
                        const option = document.createElement('option');
                        option.value = file;
                        option.text = file;
                        selectElement.appendChild(option);
                    }
                });
            }
        })
        .catch(error => {
            console.error("Error loading CSV files:", error);
            alert("Error loading CSV files: " + error.message);
        });
}

function loadFiles() {
    fetch('/get_files')
        .then(response => response.json())
        .then(data => {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            data.files.forEach(file => {
                const li = document.createElement('li');
                li.textContent = file;
                li.onclick = () => loadFile(file);
                li.oncontextmenu = (e) => {
                    e.preventDefault();
                    showFileActions(file);
                };
                fileList.appendChild(li);
            });
        })
        .catch(error => {
            console.error("Error loading files:", error);
            alert("Error loading files: " + error.message);
        });
}

setInterval(loadFiles, 5000);
loadFiles();
addCell();

const resizerSidebar = document.getElementById('resizer');
const sidebar = document.getElementById('sidebar');
const main = document.getElementById('main');
let isResizingSidebar = false;
let initialXSidebar;


const sidebarToggle = document.createElement('button');
sidebarToggle.id = 'sidebar-toggle';
sidebarToggle.className = 'btn';
sidebarToggle.innerHTML = '<i class="fas fa-chevron-right"></i>'; // Start with chevron-right
sidebarToggle.onclick = toggleSidebar;
sidebar.prepend(sidebarToggle);

function toggleSidebar() {
    sidebarCollapsed = !sidebarCollapsed;
    sidebar.style.width = sidebarCollapsed ? '50px' : '250px';
    main.style.width = sidebarCollapsed ? 'calc(100% - 50px)' : 'calc(100% - 250px)';
    sidebarToggle.innerHTML = sidebarCollapsed ? '<i class="fas fa-chevron-left"></i>' : '<i class="fas fa-chevron-right"></i>';
    preventSidebarScroll();
}


function showFileActions(filename) {
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'file-actions';
    const downloadBtn = document.createElement('button');
    downloadBtn.textContent = 'Download';
    downloadBtn.onclick = () => downloadFile(filename);
    actionsDiv.appendChild(downloadBtn);
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Delete';
    deleteBtn.onclick = () => deleteFile(filename); 
    actionsDiv.appendChild(deleteBtn);
    document.body.appendChild(actionsDiv);
    actionsDiv.style.position = 'absolute';
    actionsDiv.style.left = `${event.clientX}px`;
    actionsDiv.style.top = `${event.clientY}px`;
    actionsDiv.style.zIndex = '100';

    document.addEventListener('click', hideFileActions, { once: true });
}

function hideFileActions() {
    const actionsDiv = document.querySelector('.file-actions');
    if (actionsDiv) {
        actionsDiv.remove();
    }
}

function hidecustoms(){
    hideCustomCellPopup();
}

setInterval(loadFiles, 5000);
loadFiles();
addCell();

    
    </script>
</body>
</html>
